STEP 3 - CONSTRAINT TEMPLATES

Task:
Using spec_sheet, produce constraint templates as a JSON array.
You must DERIVE the mathematical formulas based on the semantic descriptions.

Output: Single JSON array. No surrounding text, no markdown.

=============================================================================
TEMPLATE SCHEMA (all fields required)
=============================================================================

{
  "prefix": "constraint_name",
  "template_type": "BALANCE|CAPACITY|DYNAMICS",
  "applies_when": "condition",
  "indices": ["p","l","t"],
  "equations": [
    {"name_suffix": "...", "sense": "<=|=|>=", "lhs": "your formula", "rhs": "your formula"}
  ],
  "notes": ["boundary handling notes"]
}

=============================================================================
CONSTRAINT FAMILIES TO FORMULATE
=============================================================================

Derive the LHS and RHS for each constraint based on its semantic meaning:

1. DEMAND ROUTE
   - Type: BALANCE
   - Purpose: The total demand that a product redirects to substitutes cannot 
     exceed that product's own demand
   - Applies: only when sub_edges nonempty and product has outgoing edges
   - Indices: [p, l, t]
   - Sense: <=

2. SALES CONSERVATION
   - Type: BALANCE
   - Purpose: For each product/location/period, total sales (from all life 
     buckets) plus lost sales must equal the effective demand. Effective 
     demand = original demand + inbound substitution - outbound substitution.
   - Applies: always
   - Indices: [p, l, t]
   - Sense: =
   - Note: L (lost sales) MUST appear on the left side

3. AVAILABILITY
   - Type: BALANCE
   - Purpose: Sales from any life bucket cannot exceed inventory in that bucket
   - Applies: always
   - Indices: [p, l, t, a]
   - Sense: <=

4. AGING
   - Type: DYNAMICS
   - Purpose: Inventory in bucket a at period t+1 equals inventory from bucket 
     a+1 at period t minus sales from that bucket. This represents inventory 
     aging by one bucket each period.
   - Applies: when shelf_life active
   - Indices: [p, l, t, a] where t < T and a < shelf_life[p]
   - Sense: =
   - CRITICAL: Do NOT create for t = T

5. EXPIRE CLEAR
   - Type: DYNAMICS
   - Purpose: Waste equals unsold inventory from the expiring bucket (a=1)
   - Applies: when shelf_life active
   - Indices: [p, l, t]
   - Sense: =

6. FRESH INFLOW
   - Type: DYNAMICS
   - Purpose: Fresh inventory enters at the highest life bucket. It comes from 
     orders placed lead_time periods ago.
   - Applies: when shelf_life active
   - Indices: [p, l, t]
   - Sense: =
   - CRITICAL: If t <= lead_time, fresh inflow is 0. Never access negative periods.

7. INITIALIZATION (t=1)
   - Type: DYNAMICS
   - Purpose: At the start, all non-fresh inventory buckets are empty
   - Applies: at t = 1
   - Indices: [p, l] for each a < shelf_life[p]
   - Sense: =
   - CRITICAL: This prevents "free" phantom inventory

8. STORAGE CAPACITY
   - Type: CAPACITY
   - Purpose: Total weighted inventory at each location cannot exceed storage limit
   - Applies: when cold_capacity present
   - Indices: [l, t]
   - Sense: <=

9. PRODUCTION CAPACITY
   - Type: CAPACITY
   - Purpose: Total orders across locations cannot exceed production capacity
   - Applies: when production_cap present
   - Indices: [p, t]
   - Sense: <=
   - Note: production_cap is 0-indexed list

=============================================================================
SUBSTITUTION SEMANTICS
=============================================================================

sub_edges = [[p_from, p_to], ...] means p_from's demand can be served by p_to.
S[p_from, p_to, l, t] = quantity of p_from's demand served by p_to.

For each product p, conceptually compute:
- outbound: sum of S where p is the FROM product (p sends demand out)
- inbound: sum of S where p is the TO product (p receives and serves demand)

=============================================================================
YOUR TASK
=============================================================================

For each constraint family:
1. Understand the semantic meaning
2. Derive the mathematical LHS expression
3. Derive the mathematical RHS expression
4. Document boundary conditions in notes

=============================================================================
DO NOT
=============================================================================

- Do NOT use variable 'd' - compute demand as demand_curve[p][t-1] * demand_share[l]
- Do NOT forget L[p,l,t] in sales_conservation
- Do NOT create aging constraints for t = T
- Do NOT access orders from period 0 or negative periods
- Do NOT forget initialization constraints at t = 1