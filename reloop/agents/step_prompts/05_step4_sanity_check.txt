STEP 4 — NON-SOLVER SANITY CHECKS (LOGIC-ONLY)

Task:
Run the 6 sanity checks on the current:
- contract (Step0)
- spec_sheet (Step2)
- constraint_templates (Step3)

Do NOT solve.
Do NOT generate code.
Do NOT invent data values.

Output:
- A single JSON object with the schema below.
- No surrounding text.

Schema:
{
  "checks": [
    {"id": 1, "name": "hard_equals_really_hard", "pass": true, "reason": "...", "fix_hint": "..."},
    {"id": 2, "name": "unit_consistency", "pass": true, "reason": "...", "fix_hint": "..."},
    {"id": 3, "name": "time_alignment", "pass": true, "reason": "...", "fix_hint": "..."},
    {"id": 4, "name": "conservation_closed", "pass": true, "reason": "...", "fix_hint": "..."},
    {"id": 5, "name": "boundary_handled", "pass": true, "reason": "...", "fix_hint": "..."},
    {"id": 6, "name": "extreme_cases_behavior", "pass": true, "reason": "...", "fix_hint": "..."}
  ],
  "overall_pass": true,
  "blockers": ["list of constraint family prefixes that must be fixed before codegen"],
  "recommended_next_step": "PROCEED_TO_CODEGEN|REVISE_SPEC"
}

Global evaluation rules:
- Only check logic/structure and link completeness; do not judge numerical tightness.
- A check fails if required mechanisms are missing, contradictory, or left as “free variables” when they should be definitions.
- "blockers" must list the exact template prefixes responsible for failures (e.g., ["fresh_inflow","expire_clear"]).

Required invariants (must be enforced):
- If contract allows unmet demand (lost sales), demand_route MUST include L even if penalty is zero; penalty source is costs.lost_sales when present.
- If shelf_life is active, BOTH I and y must be indexed by remaining life (A), and "aging" + "expire_clear" + "fresh_inflow" templates must exist.
- If substitution exists, BOTH demand-side (demand_route with S) AND supply-side coupling (sales_conservation linking y to d and S outflows) must exist.
- Waste must be a defined physical mechanism when shelf_life active: expire_clear must be equality defining W, not a free variable or inequality.
- Production capacity must be global per product per period: prod_cap must constrain sum_l Q[p,l,t].

Sanity checks:

1) hard_equals_really_hard
Pass conditions:
- All physical-law/accounting identity templates use "=" (not inequalities).
- Specifically, when shelf_life active:
  - aging uses "="
  - expire_clear uses "=" and defines W from I and y
  - fresh_inflow uses "=" and assigns inflow to freshest bucket
- When lost sales allowed:
  - demand_route includes L explicitly (not implicit).
Fail if:
- Any of the above are missing or relaxed.
Fix hint format:
- "Add/replace template <prefix>: change sense to '=' and define <lhs> as <rhs>"

2) unit_consistency
Pass conditions:
- demand_route relates demand quantities to d/S/L only (no costs).
- sales_conservation links y to d and S outflows (quantities only).
- availability compares y (quantity) to I (quantity).
- storage_cap uses I weighted by cold_usage <= cold_capacity.
- prod_cap uses Q summed over locations <= production_cap.
Fail if:
- Any template mixes cost terms into balance equations or uses cost keys inside flow constraints.
Fix hint:
- "Remove cost terms from constraint <prefix>; keep costs only in objective_terms"

3) time_alignment
Pass conditions:
- aging uses (t -> t+1) mapping.
- fresh_inflow uses Q at (t-lead[p]) when lead_time_positive; returns uses (t-1) when active.
- spec_sheet.edge_cases includes a PAD_LAST policy for any list-valued per-period parameter shorter than T.
Fail if:
- fresh_inflow depends on Q at time t while claiming lead_time_positive; returns depends on y at t; OR no PAD_LAST policy exists.
Fix hint:
- "Rewrite <prefix> RHS to use shifted index (t-lead[p]) or (t-1) and add PAD_LAST edge case"

4) conservation_closed
Pass conditions:
- demand_route exists and references demand, d, (S inbound if active), and L.
- sales_conservation exists and links sum_a y to d + substitution outflows.
- aging + fresh_inflow define how I evolves without missing sources/sinks.
- If substitution exists, S appears on BOTH demand-side and supply-side.
Fail if:
- demand can be met without consuming inventory, or inventory can appear/disappear unaccounted.
Fix hint:
- "Add sales_conservation linking sum_a y to d + substitution outflows; ensure S appears on both sides"

5) boundary_handled
Pass conditions:
- Notes address:
  - t=0 initialization,
  - t < lead[p] arrivals are zero,
  - aging only for valid a where a+1 exists,
  - a=1 expiration handled by expire_clear,
  - time series PAD_LAST alignment when lists shorter than T.
Fail if:
- Any boundary is unmentioned.
Fix hint:
- "Add notes to <prefix> specifying boundary handling; do not enumerate equations"

6) extreme_cases_behavior
Pass conditions:
- If all costs are zero, model remains feasible and objective reduces to 0 without breaking structure.
- If lost_sales penalty absent but contract allows lost sales, L still exists and routes unmet demand (penalty may be 0).
- If sub_edges empty, templates do not require S and sales_conservation reduces to sum_a y = d.
- If trans_edges empty, fresh_inflow does not reference X.

Fail if:
- Any module-off scenario breaks required structure.
Fix hint:
- "Guard <prefix> with applies_when; remove references to inactive variables; provide reduced-form equations"

Decision rule:
- overall_pass is true only if ALL checks pass.
- If any check fails:
  - overall_pass = false
  - recommended_next_step = "REVISE_SPEC"
  - blockers must list the responsible prefixes.
- If all pass:
  - overall_pass = true
  - recommended_next_step = "PROCEED_TO_CODEGEN"

