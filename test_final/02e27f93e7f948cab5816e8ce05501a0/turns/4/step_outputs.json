[
  "prefix='demand_route' template_type='BALANCE' applies_when='network.sub_edges is nonempty and product p has outgoing substitution edges' indices=['p', 'l', 't'] equations=[Equation(name_suffix='', sense='<=', lhs=\"sum(S[p, p_to, l, t] for [p, p_to] in data['network']['sub_edges'])\", rhs=\"data['demand_curve'][p][t-1] * data['demand_share'][l]\")] notes=['Only create for products that appear as p_from in sub_edges']",
  "prefix='sales_conservation' template_type='BALANCE' applies_when='always' indices=['p', 'l', 't'] equations=[Equation(name_suffix='', sense='=', lhs=\"sum(y[p, l, t, a] for a in range(1, data['shelf_life'][p] + 1)) + L[p, l, t]\", rhs=\"data['demand_curve'][p][t-1] * data['demand_share'][l] + sum(S[p_from, p, l, t] for [p_from, p] in data['network']['sub_edges']) - sum(S[p, p_to, l, t] for [p, p_to] in data['network']['sub_edges'])\")] notes=['L must appear on left side', 'Handle empty sub_edges by treating sums as 0']",
  "prefix='availability' template_type='BALANCE' applies_when='always' indices=['p', 'l', 't', 'a'] equations=[Equation(name_suffix='', sense='<=', lhs='y[p, l, t, a]', rhs='I[p, l, t, a]')] notes=['Create for all valid life buckets a in range(1, shelf_life[p] + 1)']",
  "prefix='aging' template_type='DYNAMICS' applies_when='t < T and a < shelf_life[p]' indices=['p', 'l', 't', 'a'] equations=[Equation(name_suffix='', sense='=', lhs='I[p, l, t+1, a]', rhs='I[p, l, t, a+1] - y[p, l, t, a+1]')] notes=['Do NOT create for t = T', 'Links period t+1 bucket a to period t bucket a+1']",
  "prefix='expire_clear' template_type='DYNAMICS' applies_when='shelf_life active' indices=['p', 'l', 't'] equations=[Equation(name_suffix='', sense='=', lhs='W[p, l, t]', rhs='I[p, l, t, 1] - y[p, l, t, 1]')] notes=['Waste equals unsold inventory from bucket a=1']",
  "prefix='fresh_inflow' template_type='DYNAMICS' applies_when='shelf_life active' indices=['p', 'l', 't'] equations=[Equation(name_suffix='', sense='=', lhs=\"I[p, l, t, data['shelf_life'][p]]\", rhs=\"Q[p, l, t - data['lead_time'][p]] if t > data['lead_time'][p] else 0\")] notes=['Fresh inventory at highest bucket', 'Zero if t <= lead_time[p]']",
  "prefix='initialization' template_type='DYNAMICS' applies_when='t = 1' indices=['p', 'l'] equations=[Equation(name_suffix='_a{a}', sense='=', lhs='I[p, l, 1, a]', rhs='0')] notes=['Create for each a < shelf_life[p]', 'Prevents phantom inventory at start']",
  "prefix='storage_cap' template_type='CAPACITY' applies_when='cold_capacity present' indices=['l', 't'] equations=[Equation(name_suffix='', sense='<=', lhs=\"sum(data['cold_usage'][p] * sum(I[p, l, t, a] for a in range(1, data['shelf_life'][p] + 1)) for p in data['products'])\", rhs=\"data['cold_capacity'][l]\")] notes=['Sum over all products and life buckets at location']",
  "prefix='prod_cap' template_type='CAPACITY' applies_when='production_cap present' indices=['p', 't'] equations=[Equation(name_suffix='', sense='<=', lhs=\"sum(Q[p, l, t] for l in data['locations'])\", rhs=\"data['production_cap'][p][t-1]\")] notes=['production_cap is 0-indexed list, use [t-1]']"
]